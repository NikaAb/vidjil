{{extend 'db_layout.html'}}

{{('message' in globals())}}
{{if 'message' in globals():}}

{{if request.vars["config_id"]:}}
    {{config_id = long(request.vars["config_id"])}}
{{else:}}
    {{config_id = db(db.config).select()[0].id}}
{{pass}}

{{
patient = db.patient[request.vars["id"]]
}}


<div>
    <h3>{{=patient.last_name + " " + patient.first_name}}  ({{=request.vars["id"]}})</h3>
    <div>
        choose config 
        <span>
            <select id="choose_config" name="config" onchange="db.call('patient/info', {'id' :'{{=request.vars['id']}}', 'config_id' : this.value})">
                {{ 
                query = db(db.config).select() 
                
                for row in query :}}
                    <option value="{{=row.id }}" {{if row.id==config_id:}}selected{{pass}} >
                        {{=row.name}} 
                    </option>
                {{pass}}
            </select>
        </span>
    </div>
</div>

<div id="db_table_container">
    <table class="db_table" id="table">
        <thead>
            <tr><td class="column1"> file_name </td>
                <td class="column2"> sampling date </td>
                <td> info </td>
                <td class="column4"> status </td>
                <td class="column2"> vidjil run date </td>
                <td class="column5"> </td>
                <td class="column5"> </td>
                <td class="column5"> </td>
            </tr>
        </thead>
        <tbody>
            {{ 
            query = db( 
                (db.sequence_file.patient_id==db.patient.id) 
                & (db.patient.id==request.vars["id"]) 
            ).select(
                left=db.data_file.on(
                    (db.data_file.sequence_file_id==db.sequence_file.id) 
                    & (db.data_file.config_id==str(config_id) ) 
                ) 
            ) 

            for row in query :}}
                 <tr>
                    <td> {{ (filename, str) = db.sequence_file.data_file.retrieve(row.sequence_file.data_file)}} {{=filename}}</td>
                    <td> {{=row.sequence_file.sampling_date}} </td>
                    <td> {{=row.sequence_file.info}} </td>
                    <td> {{if row.data_file.id == None :}}
                        <span class="button" onclick="db.request('default/run_request', { 'sequence_file_id' : '{{=row.sequence_file.id}}' , 'config_id' : {{=config_id}} } )"> run >> </span>
                         {{else:}}
                             {{=row.data_file.status}}
                         {{pass}}
                    </td>
                    <td> {{=row.data_file.run_date}} </td>
                    <td> <a href="{{=URL('download', scheme='http', args=row.sequence_file.data_file)}}" >dl</a> </td>
                    <td onclick="db.call('file/edit', {'id' :'{{=row.sequence_file.id}}', 'patient_id' :'{{=request.vars['id']}}'} )" > e </td>
                    <td onclick="db.call('file/confirm', {'id' :'{{=row.sequence_file.id}}', 'patient_id' :'{{=request.vars['id']}}'} )" > X </td>
                </tr>
            {{pass}}
        </tbody>
    </table>
    <table class="db_table" id="db_fixed_header"></table>
</div>
    
<span class="button" onclick="db.call('patient/index')"> back to list </span>
<span class="button" onclick="db.call('file/add', { 'id' : '{{=request.vars["id"]}}' } )"> add file </span>
<span class="button" onclick="db.load_data( { 'patient_id' : '{{=request.vars["id"]}}' , 'config_id' : {{=config_id}} } )" > see result </span>
</div>

{{elif 'content' in globals():}}
{{=content}}
{{else:}}
{{=BEAUTIFY(response._vars)}}
{{pass}}
